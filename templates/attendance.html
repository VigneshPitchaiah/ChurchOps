{% extends "base.html" %}

{% block title %}Mark Attendance - Church Attendance System{% endblock %}

{% block head %}
<style>
    .department-section {
        margin-bottom: 1.5rem;
    }
    .team-section {
        margin-left: 1rem;
        margin-bottom: 1rem;
    }
    .cell-section {
        margin-left: 2rem;
        margin-bottom: 0.75rem;
    }
    .people-list {
        margin-left: 3rem;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 0.5rem;
    }
    .section-title {
        margin-bottom: 0.5rem;
        font-weight: bold;
        cursor: pointer;
    }
    .section-title:hover {
        color: var(--primary-color);
    }
    .search-results {
        margin-top: 0.5rem;
        max-height: 300px;
        overflow-y: auto;
    }
    .checkbox-label {
        display: flex;
        align-items: center;
    }
    .checkbox-label.marked {
        color: var(--primary-color);
        font-weight: bold;
    }
    .submit-container {
        margin-top: 1rem;
        text-align: right;
    }
    .collapsible {
        background-color: #f8f8f8;
        padding: 0.5rem;
        border-radius: 4px;
        border-left: 3px solid var(--primary-color);
    }
    .hidden {
        display: none;
    }
    .person-checkbox {
        margin-right: 0.5rem;
    }
    .filter-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    .filter-item {
        display: flex;
        flex-direction: column;
    }
    .filter-item label {
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .filter-item select, .filter-item input {
        padding: 0.5rem;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
    .filter-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 1rem;
    }
    .filter-actions button {
        padding: 0.5rem 1rem;
    }
    .filter-stats {
        margin: 1rem 0;
        padding: 0.5rem;
        background-color: #f0f0f0;
        border-radius: 4px;
        font-weight: bold;
    }
    .sticky-panel {
        position: sticky;
        top: 70px; /* Match the header height to position just below it */
        z-index: 100;
        background-color: white;
        padding: 1rem;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    .region-section {
        margin-bottom: 1.5rem;
    }
    .direction-section {
        margin-left: 1rem;
        margin-bottom: 1rem;
    }
    
    /* New styles for table view */
    .attendance-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }
    
    .attendance-table th {
        background-color: #f0f0f0;
        padding: 8px;
        text-align: left;
        font-weight: bold;
        border-bottom: 2px solid #ddd;
    }
    
    .attendance-table td {
        padding: 8px;
        border-bottom: 1px solid #ddd;
    }
    
    .attendance-table tr:hover {
        background-color: #f5f5f5;
    }
    
    .attendance-table tr.marked {
        background-color: rgba(var(--primary-color-rgb), 0.1);
    }
    
    .attendance-stats {
        margin: 0.5rem 0;
        font-weight: bold;
    }
    
    .table-controls {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
    }
    
    .mark-all-container {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .search-box {
        position: relative;
        flex-grow: 1;
        max-width: 300px;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
        .sticky-panel {
            top: 100px; /* Adjust for taller mobile header */
        }
        .filter-container {
            grid-template-columns: 1fr;
        }
        .people-list {
            grid-template-columns: 1fr;
            margin-left: 1rem;
        }
        .attendance-table th:nth-child(3),
        .attendance-table th:nth-child(4),
        .attendance-table th:nth-child(5),
        .attendance-table th:nth-child(6),
        .attendance-table td:nth-child(3),
        .attendance-table td:nth-child(4),
        .attendance-table td:nth-child(5),
        .attendance-table td:nth-child(6) {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <h1>Mark Attendance</h1>
    <p>
        <strong>Service:</strong> {{ service[1] }}<br>
        <strong>Date:</strong> {{ service[2] }}<br>
        <strong>Time:</strong> {{ service[3] }}
    </p>
    
    <div class="sticky-panel">
        <h2>Filters</h2>
        <form id="filterForm" method="GET" action="{{ url_for('attendance', service_id=service[0]) }}">
            <div class="filter-container">
                <div class="filter-item">
                    <label for="region_filter">Region:</label>
                    <select name="region_id" id="region_filter" onchange="updateDirectionOptions()">
                        <option value="">All Regions</option>
                        {% for region in regions %}
                        <option value="{{ region[0] }}" {% if filters.region_id|string == region[0]|string %}selected{% endif %}>
                            {{ region[1] }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="direction_filter">Direction:</label>
                    <select name="direction_id" id="direction_filter" onchange="updateDepartmentOptions()">
                        <option value="">All Directions</option>
                        {% for direction in directions %}
                        <option value="{{ direction[0] }}" 
                                data-region="{{ direction[2] }}"
                                {% if filters.direction_id|string == direction[0]|string %}selected{% endif %}>
                            {{ direction[1] }} ({{ direction[3] }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="department_filter">Department:</label>
                    <select name="department_id" id="department_filter" onchange="updateTeamOptions()">
                        <option value="">All Departments</option>
                        {% for dept in departments %}
                        <option value="{{ dept[0] }}" 
                                data-direction="{{ dept[2] }}"
                                {% if filters.department_id|string == dept[0]|string %}selected{% endif %}>
                            {{ dept[1] }} ({{ dept[3] }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="team_filter">Team:</label>
                    <select name="team_id" id="team_filter" onchange="updateCellOptions()">
                        <option value="">All Teams</option>
                        {% for team in teams %}
                        <option value="{{ team[0] }}" 
                                data-dept="{{ team[2] }}"
                                {% if filters.team_id|string == team[0]|string %}selected{% endif %}>
                            {{ team[1] }} ({{ team[3] }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="cell_filter">Cell:</label>
                    <select name="cell_id" id="cell_filter">
                        <option value="">All Cells</option>
                        {% for cell in cells %}
                        <option value="{{ cell[0] }}" 
                                data-team="{{ cell[2] }}"
                                {% if filters.cell_id|string == cell[0]|string %}selected{% endif %}>
                            {{ cell[1] }} ({{ cell[3] }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="is_active">Member Status:</label>
                    <select name="is_active" id="is_active">
                        <option value="true" {% if filters.is_active == 'true' %}selected{% endif %}>Active Members</option>
                        <option value="false" {% if filters.is_active == 'false' %}selected{% endif %}>Inactive Members</option>
                    </select>
                </div>
                
                <div class="filter-item">
                    <label for="name_search">Name Search:</label>
                    <input type="text" name="name_search" id="name_search" placeholder="Search by name" 
                          value="{{ filters.name_search }}">
                </div>
            </div>
            
            <div class="filter-actions">
                <button type="submit" class="btn">Apply Filters</button>
                <a href="{{ url_for('attendance', service_id=service[0]) }}" class="btn btn-secondary">Clear Filters</a>
            </div>
        </form>
        
        <div class="filter-stats">
            {% set total_members = 0 %}
            {% set marked_members = 0 %}
            
            {% for region_name, region in organized_people.items() %}
                {% for direction_name, direction in region.directions.items() %}
                    {% for dept_name, dept in direction.departments.items() %}
                        {% for team_name, team in dept.teams.items() %}
                            {% for cell_name, cell in team.cells.items() %}
                                {% for person in cell.people %}
                                    {% set total_members = total_members + 1 %}
                                    {% if person.marked %}
                                        {% set marked_members = marked_members + 1 %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                {% endfor %}
            {% endfor %}
            
            <div>{{ marked_members }} of {{ total_members }} members marked ({{ 0 if total_members == 0 else (marked_members * 100 / total_members)|round }}%)</div>
        </div>
    </div>
    
    <div class="table-controls">
        <div class="mark-all-container">
            <button type="button" id="markAllBtn" class="btn btn-secondary btn-sm">Mark All</button>
            <button type="button" id="unmarkAllBtn" class="btn btn-secondary btn-sm">Unmark All</button>
        </div>
        <div class="search-box">
            <input type="text" id="tableSearch" placeholder="Filter table..." class="search-input">
        </div>
    </div>
    
    <div id="loadingSpinner" class="loading-spinner">
        Loading...
    </div>
    
    <form method="POST">
        <div class="attendance-table-container">
            <table class="attendance-table" id="attendanceTable">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAll"></th>
                        <th>Name</th>
                        <th>Cell</th>
                        <th>Team</th>
                        <th>Department</th>
                        <th>Direction</th>
                        <th>Region</th>
                    </tr>
                </thead>
                <tbody>
                    {% set all_people = [] %}
                    {% for region_name, region in organized_people.items() %}
                        {% for direction_name, direction in region.directions.items() %}
                            {% for dept_name, dept in direction.departments.items() %}
                                {% for team_name, team in dept.teams.items() %}
                                    {% for cell_name, cell in team.cells.items() %}
                                        {% for person in cell.people %}
                                            {% set _ = all_people.append({
                                                'id': person.id,
                                                'name': person.name,
                                                'cell': cell_name,
                                                'team': team_name,
                                                'department': dept_name,
                                                'direction': direction_name,
                                                'region': region_name,
                                                'marked': person.marked
                                            }) %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endfor %}
                            {% endfor %}
                        {% endfor %}
                    {% endfor %}
                    
                    {% for person in all_people %}
                    <tr class="person-row {% if person.marked %}marked{% endif %}" data-person-id="{{ person.id }}">
                        <td>
                            <input type="checkbox" name="person_ids" value="{{ person.id }}" class="person-checkbox" 
                                {% if person.marked %}checked{% endif %}>
                        </td>
                        <td>{{ person.name }}</td>
                        <td>{{ person.cell }}</td>
                        <td>{{ person.team }}</td>
                        <td>{{ person.department }}</td>
                        <td>{{ person.direction }}</td>
                        <td>{{ person.region }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="submit-container">
            <textarea name="notes" placeholder="Notes (optional)" rows="2" style="width: 100%; margin-bottom: 1rem;"></textarea>
            <button type="submit" class="btn">Save Attendance</button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Lightweight, optimized JavaScript for attendance marking
    document.addEventListener('DOMContentLoaded', function() {
        // Get elements
        const tableSearch = document.getElementById('tableSearch');
        const attendanceTable = document.getElementById('attendanceTable');
        const selectAll = document.getElementById('selectAll');
        const markAllBtn = document.getElementById('markAllBtn');
        const unmarkAllBtn = document.getElementById('unmarkAllBtn');
        const personCheckboxes = document.querySelectorAll('.person-checkbox');
        
        // Quick table search filter
        tableSearch.addEventListener('input', function() {
            const query = this.value.toLowerCase();
            const rows = attendanceTable.querySelectorAll('tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(query)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
        
        // Select all functionality
        selectAll.addEventListener('change', function() {
            const visibleRows = Array.from(attendanceTable.querySelectorAll('tbody tr'))
                .filter(row => row.style.display !== 'none');
                
            visibleRows.forEach(row => {
                const checkbox = row.querySelector('.person-checkbox');
                checkbox.checked = selectAll.checked;
                if (selectAll.checked) {
                    row.classList.add('marked');
                } else {
                    row.classList.remove('marked');
                }
            });
        });
        
        // Mark all visible
        markAllBtn.addEventListener('click', function() {
            const visibleRows = Array.from(attendanceTable.querySelectorAll('tbody tr'))
                .filter(row => row.style.display !== 'none');
                
            visibleRows.forEach(row => {
                const checkbox = row.querySelector('.person-checkbox');
                checkbox.checked = true;
                row.classList.add('marked');
            });
            
            // Update select all checkbox
            selectAll.checked = true;
        });
        
        // Unmark all visible
        unmarkAllBtn.addEventListener('click', function() {
            const visibleRows = Array.from(attendanceTable.querySelectorAll('tbody tr'))
                .filter(row => row.style.display !== 'none');
                
            visibleRows.forEach(row => {
                const checkbox = row.querySelector('.person-checkbox');
                checkbox.checked = false;
                row.classList.remove('marked');
            });
            
            // Update select all checkbox
            selectAll.checked = false;
        });
        
        // Highlight rows when checkboxes are clicked
        personCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const row = this.closest('tr');
                if (this.checked) {
                    row.classList.add('marked');
                } else {
                    row.classList.remove('marked');
                }
            });
        });
        
        // Dynamic filtering functionality
        function updateDirectionOptions() {
            const regionSelect = document.getElementById('region_filter');
            const directionSelect = document.getElementById('direction_filter');
            const selectedRegion = regionSelect.value;
            
            // Reset direction selection
            directionSelect.value = '';
            
            // Show/hide direction options based on region
            Array.from(directionSelect.options).forEach(option => {
                if (option.value === '') return; // Skip the "All Directions" option
                
                if (!selectedRegion || option.dataset.region === selectedRegion) {
                    option.style.display = '';
                } else {
                    option.style.display = 'none';
                }
            });
            
            // Update departments as well
            updateDepartmentOptions();
        }
        
        // Initialize the options on page load
        window.updateDirectionOptions = updateDirectionOptions;
        window.updateDepartmentOptions = updateDepartmentOptions;
        window.updateTeamOptions = updateTeamOptions;
        window.updateCellOptions = updateCellOptions;
    });
    
    // Dynamic filtering functionality (continued)
    function updateDepartmentOptions() {
        const directionSelect = document.getElementById('direction_filter');
        const departmentSelect = document.getElementById('department_filter');
        const selectedDirection = directionSelect.value;
        
        // Reset department selection
        departmentSelect.value = '';
        
        // Show/hide department options based on direction
        Array.from(departmentSelect.options).forEach(option => {
            if (option.value === '') return; // Skip the "All Departments" option
            
            if (!selectedDirection || option.dataset.direction === selectedDirection) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });
        
        // Update teams as well
        updateTeamOptions();
    }
    
    function updateTeamOptions() {
        const departmentSelect = document.getElementById('department_filter');
        const teamSelect = document.getElementById('team_filter');
        const selectedDepartment = departmentSelect.value;
        
        // Reset team selection
        teamSelect.value = '';
        
        // Show/hide team options based on department
        Array.from(teamSelect.options).forEach(option => {
            if (option.value === '') return; // Skip the "All Teams" option
            
            if (!selectedDepartment || option.dataset.dept === selectedDepartment) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });
        
        // Update cells as well
        updateCellOptions();
    }
    
    function updateCellOptions() {
        const teamSelect = document.getElementById('team_filter');
        const cellSelect = document.getElementById('cell_filter');
        const selectedTeam = teamSelect.value;
        
        // Reset cell selection
        cellSelect.value = '';
        
        // Show/hide cell options based on team
        Array.from(cellSelect.options).forEach(option => {
            if (option.value === '') return; // Skip the "All Cells" option
            
            if (!selectedTeam || option.dataset.team === selectedTeam) {
                option.style.display = '';
            } else {
                option.style.display = 'none';
            }
        });
    }
</script>
{% endblock %}
