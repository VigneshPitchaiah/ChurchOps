{% extends "base.html" %}

{% block title %}Mark Attendance - ChurchOps{% endblock %}

{% block page_title %}Mark Attendance: {{ service.service_name }} ({{ service.formatted_date }}){% endblock %}

{% block content %}
<div id="loading-overlay" class="loading-overlay hidden">
    <div class="spinner"></div>
    <p>Loading data...</p>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Filters</h2>
    </div>
    <div class="card-body">
        <form id="attendance-filter-form" class="no-ajax" action="{{ url_for('attendance.attendance_form', service_id=service.service_id) }}" method="get">
            <div class="grid">
                <div class="col-2 col-md-6 col-sm-12">
                    <div class="form-group">
                        <label for="name_search" class="form-label">Name</label>
                        <input type="text" name="name_search" id="name_search" class="form-control" value="{{ filters.name_search }}">
                    </div>
                </div>

                <div class="col-2 col-md-6 col-sm-12">
                    <div class="form-group">
                        <label for="country" class="form-label">Country</label>
                        <select name="country" id="country" class="form-select">
                            <option value="">All Countries</option>
                            {% for country_option in countries %}
                                <option value="{{ country_option }}" {% if filters.country == country_option %}selected{% endif %}>
                                    {{ country_option }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-2 col-md-6 col-sm-12">
                    <div class="form-group">
                        <label for="region_id" class="form-label">Region</label>
                        <select name="region_id" id="region_id" class="form-select">
                            <option value="">All Regions</option>
                            {% for region in regions %}
                                <option value="{{ region.region_id }}" {% if filters.region_id == region.region_id %}selected{% endif %}>
                                    {{ region.region_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-2 col-md-6 col-sm-12">
                    <div class="form-group">
                        <label for="direction_id" class="form-label">Zones</label>
                        <select name="direction_id" id="direction_id" class="form-select">
                            <option value="">All Zones</option>
                            {% for direction in directions %}
                                <option value="{{ direction.direction_id }}" {% if filters.direction_id == direction.direction_id %}selected{% endif %}>
                                    {{ direction.direction_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-2 col-md-6 col-sm-12">
                    <div class="form-group">
                        <label for="department_id" class="form-label">Department</label>
                        <select name="department_id" id="department_id" class="form-select">
                            <option value="">All Departments</option>
                            {% for department in departments %}
                                <option value="{{ department.department_id }}" {% if filters.department_id == department.department_id %}selected{% endif %}>
                                    {{ department.department_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="grid mt-3">
                <div class="col-3 col-md-6 col-sm-12">
                    <div class="form-group">
                        <label for="team_id" class="form-label">Team</label>
                        <select name="team_id" id="team_id" class="form-select">
                            <option value="">All Teams</option>
                            {% for team in teams %}
                                <option value="{{ team.team_id }}" {% if filters.team_id == team.team_id %}selected{% endif %}>
                                    {{ team.team_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-3 col-md-6 col-sm-12">
                    <div class="form-group">
                        <label for="cell_id" class="form-label">Cell</label>
                        <select name="cell_id" id="cell_id" class="form-select">
                            <option value="">All Cells</option>
                            {% for cell in cells %}
                                <option value="{{ cell.cell_id }}" {% if filters.cell_id == cell.cell_id %}selected{% endif %}>
                                    {{ cell.cell_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-6 col-md-12 col-sm-12">
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                        <a href="{{ url_for('attendance.attendance_form', service_id=service.service_id) }}" class="btn btn-outline">Reset</a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<form id="attendance-form" action="{{ url_for('attendance.mark_attendance', service_id=service.service_id) }}" method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Mark Attendance</h2>
            <div class="attendance-legend">
                <span class="legend-item"><span class="status-indicator present"></span> Present</span>
                <span class="legend-item"><span class="status-indicator absent"></span> Absent</span>
                <span class="legend-item"><span class="status-indicator watched-recording"></span> Watched Recording</span>
                <span class="legend-item"><span class="status-indicator not-marked"></span> Not Marked</span>
            </div>
        </div>

        <div class="card-body">
            <div class="table-container">
                <table class="table">
                    <thead>
                        <tr>
                            <th class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="select-all-checkbox">
                                    <label class="form-check-label" for="select-all-checkbox">All</label>
                                </div>
                            </th>
                            <th class="text-center">Status</th>
                            <th>Name</th>
                            <th>Country</th>
                            <th>Cell</th>
                            <th>Team</th>
                            <th>Department</th>
                            <th>Zones</th>
                            <th>Region</th>
                        </tr>
                    </thead>
                    <tbody id="attendance-table-body">
                        {% if organized_people %}
                            {% set people_list = [] %}
                            {% for region_name, region_data in organized_people.items() %}
                                {% for direction_name, direction_data in region_data.directions.items() %}
                                    {% for department_name, department_data in direction_data.departments.items() %}
                                        {% for team_name, team_data in department_data.teams.items() %}
                                            {% for cell_name, cell_data in team_data.cells.items() %}
                                                {% for person in cell_data.people %}
                                                    {% set _ = people_list.append({
                                                        'id': person.id,
                                                        'name': person.name,
                                                        'status': person.status|default('not-marked'),
                                                        'country': person.country|default('Not specified'),
                                                        'cell': cell_name,
                                                        'team': team_name,
                                                        'department': department_name,
                                                        'direction': direction_name,
                                                        'region': region_name,
                                                        'marked': person.marked
                                                    }) %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% endfor %}
                                    {% endfor %}
                                {% endfor %}
                            {% endfor %}
                            
                            {% for person in people_list %}
                                <tr class="person-row status-{{ person.status }} {% if person.marked %}previously-marked{% endif %}" data-cell="{{ person.cell }}">
                                    <td class="text-center">
                                        <input type="checkbox" class="person-checkbox" data-person-id="{{ person.id }}">
                                    </td>
                                    <td class="text-center">
                                        <div class="attendance-control">
                                            <select name="person_status[{{ person.id }}]" class="attendance-select" id="status-{{ person.id }}">
                                                <option value="not-marked" {% if person.status == 'not-marked' %}selected{% endif %}>Not Marked</option>
                                                <option value="present" {% if person.status == 'present' %}selected{% endif %}>Present</option>
                                                <option value="absent" {% if person.status == 'absent' %}selected{% endif %}>Absent</option>
                                                <option value="watched-recording" {% if person.status == 'watched-recording' %}selected{% endif %}>Watched Recording</option>
                                            </select>
                                        </div>
                                    </td>
                                    <td>{{ person.name }}</td>
                                    <td>{{ person.country }}</td>
                                    <td>{{ person.cell }}</td>
                                    <td>{{ person.team }}</td>
                                    <td>{{ person.department }}</td>
                                    <td>{{ person.direction }}</td>
                                    <td>{{ person.region }}</td>
                                </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="9" class="text-center">No people found matching the current filters.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <div class="card-footer">
            <button type="submit" class="btn btn-primary" id="save-attendance-btn">Save Attendance</button>
            <a href="{{ url_for('services.services_list') }}" class="btn btn-outline">Back to Services</a>
        </div>
    </div>
</form>
{% endblock %}

{% block styles %}
<style>
    /* Bulk actions styling */
    .bulk-action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .btn-xs {
        padding: 1px 5px;
        font-size: 0.7rem;
        line-height: 1.5;
        border-radius: 2px;
    }
    /* Improved dropdown styling */
    .form-select {
        -webkit-appearance: none;
        -moz-appearance: none;
        -ms-appearance: none;
        appearance: none;
        padding-right: 2rem;
        background-position: right 0.5rem center;
        background-size: 1rem;
        text-overflow: ellipsis;
        max-width: 100%;
        white-space: nowrap;
        overflow: hidden;
    }
    
    /* Add spacing between form groups */
    .form-group {
        margin-bottom: 1rem;
        padding-right: 0.5rem;
    }
    
    .search-container {
        position: relative;
        margin-bottom: 1.5rem;
    }
    
    .search-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0.25rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        max-height: 300px;
        overflow-y: auto;
        z-index: 10;
    }
    
    .search-result-item {
        padding: 0.5rem 1rem;
        cursor: pointer;
    }
    
    .search-result-item:hover {
        background: #f8f9fa;
    }
    
    .people-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 0.5rem;
    }
    
    .marked {
        background-color: rgba(32, 201, 151, 0.1);
    }
    
    .form-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .person-row:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
    
    .mt-2 {
        margin-top: 0.5rem;
    }
    
    .mt-3 {
        margin-top: 1rem;
    }
    
    .table-container {
        max-height: 500px;
        overflow-y: auto;
        margin-bottom: 1rem;
    }
    
    .table {
        width: 100%;
        margin-bottom: 0;
    }
    
    /* Make the table header sticky */
    .table thead th {
        position: sticky;
        top: 0;
        background-color: #fff;
        z-index: 1;
        box-shadow: 0 1px 0 rgba(0, 0, 0, 0.1);
    }
    
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    
    .loading-overlay.hidden {
        display: none;
    }
    
    .spinner {
        border: 8px solid rgba(0, 0, 0, 0.1);
        border-top: 8px solid #3498db;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        animation: spin 2s linear infinite;
    }
    
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
    
    .attendance-legend {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
    
    .status-indicator {
        display: inline-block;
        width: 16px;
        height: 16px;
        border-radius: 50%;
    }
    
    .status-indicator.present {
        background-color: #28a745;
    }
    
    .status-indicator.absent {
        background-color: #dc3545;
    }
    
    .status-indicator.watched-recording {
        background-color: #ffc107;
    }
    
    .status-indicator.not-marked {
        background-color: #6c757d;
        opacity: 0.5;
    }
    
    .status-present {
        background-color: rgba(40, 167, 69, 0.2);
    }
    
    .status-absent {
        background-color: rgba(220, 53, 69, 0.1);
    }
    
    .status-watched-recording {
        background-color: rgba(255, 193, 7, 0.2);
    }
    
    .attendance-control {
        min-width: 120px;
    }
    
    .attendance-select {
        width: 100%;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
        border-radius: 0.25rem;
        border: 1px solid #ced4da;
    }

    /* Status row styling */
    .previously-marked {
        background-color: rgba(40, 167, 69, 0.1) !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const loadingOverlay = document.getElementById('loading-overlay');
        const searchInput = document.getElementById('name_search');
        const searchResults = document.getElementById('search-results');
        const attendanceForm = document.getElementById('attendance-form');
        const saveButton = document.getElementById('save-attendance-btn');
        
        // Extract service ID from the URL for filter persistence
        const urlParams = new URLSearchParams(window.location.search);
        const serviceId = "{{ service.service_id }}";
        
        // Function to show the loading overlay
        function showLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }
            
            // Add protection against duplicate loading overlays
            document.querySelectorAll('.loading-overlay').forEach((overlay, index) => {
                if (index > 0) overlay.remove();
            });
            
            // Set a timeout to automatically hide the loading overlay after 10 seconds
            // This prevents a stuck loading state if something goes wrong
            setTimeout(() => {
                hideLoading();
            }, 10000);
        }
        
        // Function to hide the loading overlay
        function hideLoading() {
            if (loadingOverlay) {
                loadingOverlay.classList.add('hidden');
            }
        }
        
        // Function to save current filters to localStorage
        function saveFilters() {
            if (!filterForm) return;
            
            const formData = new FormData(filterForm);
            const filterData = {};
            
            for (const [key, value] of formData.entries()) {
                if (value) { // Only save non-empty values
                    filterData[key] = value;
                }
            }
            
            localStorage.setItem('attendance_filters_' + serviceId, JSON.stringify(filterData));
        }
        
        // Function to load saved filters from localStorage
        function loadSavedFilters() {
            if (!filterForm) return;
            
            const savedFilters = localStorage.getItem('attendance_filters_' + serviceId);
            if (!savedFilters) return;
            
            try {
                const filterData = JSON.parse(savedFilters);
                
                // Apply saved filters to form
                for (const [key, value] of Object.entries(filterData)) {
                    const input = filterForm.querySelector(`[name="${key}"]`);
                    if (input) {
                        input.value = value;
                    }
                }
                
                // Trigger filter submission to apply saved filters
                setTimeout(() => {
                    filterForm.dispatchEvent(new Event('submit'));
                }, 500);
            } catch (error) {
                console.error('Error loading saved filters:', error);
            }
        }
        
        // Handle search input
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            if (query.length < 2) {
                searchResults.innerHTML = '';
                return;
            }
            
            fetch(`/attendance/search?query=${encodeURIComponent(query)}&service_id=${serviceId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    searchResults.innerHTML = '';
                    
                    if (data.results.length === 0) {
                        searchResults.innerHTML = '<div class="search-result-item">No results found</div>';
                        return;
                    }
                    
                    data.results.forEach(person => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'search-result-item';
                        resultItem.textContent = person.name;
                        resultItem.setAttribute('data-person-id', person.id);
                        resultItem.setAttribute('data-marked', person.marked);
                        
                        resultItem.addEventListener('click', function() {
                            const personId = this.getAttribute('data-person-id');
                            const isMarked = this.getAttribute('data-marked') === 'true';
                            const checkboxes = document.querySelectorAll(`input[name="person_ids"][value="${personId}"]`);
                            
                            checkboxes.forEach(checkbox => {
                                checkbox.checked = !isMarked;
                                const row = checkbox.closest('.person-row');
                                if (row) {
                                    if (isMarked) {
                                        row.classList.remove('marked');
                                    } else {
                                        row.classList.add('marked');
                                    }
                                }
                            });
                            
                            searchInput.value = '';
                            searchResults.innerHTML = '';
                        });
                        
                        searchResults.appendChild(resultItem);
                    });
                })
                .catch(error => {
                    console.error('Error searching people:', error);
                    searchResults.innerHTML = '<div class="search-result-item">Error loading results</div>';
                });
        });
        
        // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            if (!searchInput.contains(event.target) && !searchResults.contains(event.target)) {
                searchResults.innerHTML = '';
            }
        });
        
        // Reset button functionality
        const resetButton = document.querySelector('.filter-reset');
        if(resetButton) {
            resetButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Clear saved filters in localStorage
                localStorage.removeItem('attendance_filters_' + serviceId);
                
                // Reset form fields
                if (filterForm) {
                    filterForm.reset();
                    
                    // Reset all dropdowns to their first option
                    filterForm.querySelectorAll('select').forEach(select => {
                        select.selectedIndex = 0;
                    });
                    
                    // Clear text inputs
                    filterForm.querySelectorAll('input[type="text"]').forEach(input => {
                        input.value = '';
                    });
                }
                
                // Navigate to the reset URL without any filters
                const baseUrl = this.getAttribute('href').split('?')[0];
                window.location.href = baseUrl;
            });
        }
        
        // Save filters in localStorage when applied
        const filterForm = document.getElementById('attendance-filter-form');
        if(filterForm) {
            // Only load saved filters if we're not coming from a reset action
            if (!window.location.href.endsWith('/attendance/' + serviceId)) {
                loadSavedFilters();
            }
            
            filterForm.addEventListener('submit', function(e) {
                e.preventDefault();
                showLoading();
                
                // Get form data
                const formData = new FormData(this);
                // Add an ajax flag
                formData.append('ajax', 'true');
                
                // Save filters to localStorage
                saveFilters();
                
                // Build query string
                const queryParams = new URLSearchParams(formData).toString();
                
                // Make an AJAX request
                fetch(this.action + '?' + queryParams)
                    .then(response => response.text())
                    .then(html => {
                        // Parse the response HTML
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(html, 'text/html');
                        
                        // Extract the attendance table body
                        const newTable = doc.querySelector('#attendance-table-body');
                        const currentTable = document.querySelector('#attendance-table-body');
                        
                        if (newTable && currentTable) {
                            currentTable.innerHTML = newTable.innerHTML;
                            
                            // Re-attach event listeners to new elements
                            document.querySelectorAll('.attendance-select').forEach(select => {
                                select.addEventListener('change', function() {
                                    const row = this.closest('tr');
                                    if(row) {
                                        // Remove all status classes
                                        row.classList.remove('status-present', 'status-absent', 'status-not-marked', 'status-watched-recording');
                                        // Add the new status class
                                        row.classList.add(`status-${this.value}`);
                                    }
                                });
                            });
                        } else {
                            console.error('Could not find table body to update. Check for element with ID "attendance-table-body"');
                            // Try a fallback approach
                            const mainContent = doc.querySelector('.table-container');
                            const currentContent = document.querySelector('.table-container');
                            if (mainContent && currentContent) {
                                currentContent.innerHTML = mainContent.innerHTML;
                            } else {
                                // Last resort: reload the page
                                window.location.href = this.action + '?' + queryParams.replace('&ajax=true', '');
                                return;
                            }
                        }
                        
                        // Update URL without refreshing
                        const newUrl = this.action + '?' + queryParams.replace('&ajax=true', '');
                        window.history.replaceState({ path: newUrl }, '', newUrl);
                        
                        hideLoading();
                    })
                    .catch(error => {
                        console.error('Error applying filters:', error);
                        hideLoading();
                        alert('An error occurred while applying filters. Please try again.');
                    });
            });
            
            // Reset all filter values to default when page loads
            // Make sure dropdowns have their default option selected
            const filterInputs = filterForm.querySelectorAll('select, input');
            filterInputs.forEach(input => {
                if (input.tagName === 'SELECT') {
                    input.selectedIndex = 0; // Select first option (usually 'All')
                } else if (input.type === 'text') {
                    input.value = ''; // Clear text inputs
                }
            });
            
            // Add change event listeners to form inputs for real-time filtering
            const formInputs = [
                document.getElementById('name_search'),
                document.getElementById('is_active'),
                document.getElementById('region_id'),
                document.getElementById('direction_id'),
                document.getElementById('department_id'),
                document.getElementById('team_id'),
                document.getElementById('cell_id')
            ];
            
            // Setup debounce function
            function debounce(func, wait = 300) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
            
            // Add debounced event listeners to form inputs
            // Add country to form inputs if not already included
            if (document.getElementById('country') && !formInputs.includes(document.getElementById('country'))) {
                formInputs.push(document.getElementById('country'));
            }
            
            formInputs.forEach(input => {
                if (input) {
                    // Use input event for text fields, change for dropdowns
                    const eventType = input.tagName === 'INPUT' && input.type === 'text' ? 'input' : 'change';
                    input.addEventListener(eventType, debounce((e) => {
                        // Don't trigger for hierarchical dropdown updates to avoid multiple submissions
                        if (e.isTrusted) {
                            filterForm.dispatchEvent(new Event('submit'));
                        }
                    }, input.type === 'text' ? 500 : 300));
                }
            });
        }
        
        // Handle form submission with loading indicator
        if(attendanceForm) {
            attendanceForm.addEventListener('submit', function(e) {
                e.preventDefault();
                showLoading();
                
                // Submit form via AJAX
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    hideLoading();
                    if(data.success) {
                        // Clear saved filters from localStorage
                        localStorage.removeItem('attendance_filters_' + serviceId);
                        
                        alert(data.message || 'Attendance saved successfully');
                        // Update UI to reflect saved state
                        updateAttendanceUI(data.attendance);
                        
                        // Redirect to the form without filters
                        window.location.href = attendanceForm.action;
                    } else {
                        alert(data.message || 'Error saving attendance');
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Error saving attendance:', error);
                    alert('An error occurred while saving attendance. Please try again.');
                });
            });
        }
        
        // Update UI based on attendance data
        function updateAttendanceUI(attendanceData) {
            if(!attendanceData) return;
            
            // Update rows based on status
            attendanceData.forEach(item => {
                const select = document.querySelector(`select[name="person_status[${item.person_id}]"]`);
                if(select) {
                    select.value = item.status;
                    const row = select.closest('tr');
                    if(row) {
                        row.className = `person-row status-${item.status}`;
                    }
                }
            });
        }
        
        // Handle attendance status changes
        document.querySelectorAll('.attendance-select').forEach(select => {
            select.addEventListener('change', function() {
                const row = this.closest('tr');
                if(row) {
                    // Remove all status classes
                    row.classList.remove('status-present', 'status-absent', 'status-not-marked', 'status-watched-recording');
                    // Add the new status class
                    row.classList.add(`status-${this.value}`);
                }
            });
        });
        
        // Bulk selection functionality - simplified
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const personCheckboxes = document.querySelectorAll('.person-checkbox');
        
        if (selectAllCheckbox) {
            selectAllCheckbox.addEventListener('change', function() {
                personCheckboxes.forEach(checkbox => {
                    checkbox.checked = this.checked;
                    
                    // Update the status based on selection
                    const personId = checkbox.getAttribute('data-person-id');
                    const select = document.getElementById('status-' + personId);
                    if (select && this.checked) {
                        select.value = 'present';
                        // Trigger change event to update row styling
                        select.dispatchEvent(new Event('change'));
                    }
                });
            });
        }

        // Helper function to update "Select All" checkbox state
        function updateSelectAllCheckboxState() {
            if (selectAllCheckbox) {
                const totalCheckboxes = personCheckboxes.length;
                const checkedCheckboxes = document.querySelectorAll('.person-checkbox:checked').length;
                
                selectAllCheckbox.checked = (totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes);
                selectAllCheckbox.indeterminate = (checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
            }
        }
        
        // Add change event listeners to checkboxes to update Select All state
        personCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectAllCheckboxState);
        });
        
        // Auto-selection by cell
        const uniqueCells = new Set();
        document.querySelectorAll('[data-cell]').forEach(row => {
            uniqueCells.add(row.getAttribute('data-cell'));
        });
        
        // We're not using the cell selector anymore as per user request
        
        // Helper function to update "Select All" checkbox state
        function updateSelectAllCheckboxState() {
            if (selectAllCheckbox) {
                const totalCheckboxes = personCheckboxes.length;
                const checkedCheckboxes = document.querySelectorAll('.person-checkbox:checked').length;
                
                selectAllCheckbox.checked = (totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes);
                selectAllCheckbox.indeterminate = (checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
            }
        }
        
        // Add change event listeners to checkboxes to update Select All state
        personCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectAllCheckboxState);
        });
        
        // Hierarchical dropdown functionality
        // Get all dropdown elements
        const regionSelect = document.getElementById('region_id');
        const directionSelect = document.getElementById('direction_id');
        const departmentSelect = document.getElementById('department_id');
        const teamSelect = document.getElementById('team_id');
        const cellSelect = document.getElementById('cell_id');
        
        // Store all the original options for each dropdown
        const originalDirections = Array.from(directionSelect.options);
        const originalDepartments = Array.from(departmentSelect.options);
        const originalTeams = Array.from(teamSelect.options);
        const originalCells = Array.from(cellSelect.options);
        
        // Function to update dependent dropdowns
        function updateDropdowns(parentSelect, childSelect, originalOptions, attributeName) {
            const selectedValue = parentSelect.value;
            
            // Clear the child dropdown
            childSelect.innerHTML = '';
            
            // Add the "All" option first
            childSelect.appendChild(originalOptions[0].cloneNode(true));
            
            if (selectedValue) {
                // Filter and add relevant options
                originalOptions.forEach(option => {
                    if (option.value && option.getAttribute(attributeName) === selectedValue) {
                        childSelect.appendChild(option.cloneNode(true));
                    }
                });
            } else {
                // If no parent selection, add all options
                originalOptions.forEach((option, index) => {
                    if (index > 0) { // Skip the first "All" option as it's already added
                        childSelect.appendChild(option.cloneNode(true));
                    }
                });
            }
            
            // Trigger change event to cascade down
            const event = new Event('change');
            childSelect.dispatchEvent(event);
        }
        
        // Add data attributes to all options to track relationships
        function initDropdownOptions() {
            // Before we do anything, we need to add data attributes to each option to track their relationships
            // Try to infer relationships from existing data if possible
            try {
                // Manual inference approach if API is not available
                // This adds basic relationships based on option text and patterns
                // For Direction options, add data-region-id based on existing data
                originalDirections.forEach(option => {
                    if (option.value) {
                        // Find the region option that might contain this direction
                        const regionOptions = Array.from(regionSelect.options);
                        for (const regionOption of regionOptions) {
                            if (regionOption.value && option.text.includes(regionOption.text)) {
                                option.setAttribute('data-region-id', regionOption.value);
                                break;
                            }
                        }
                    }
                });
                
                // For Department options, we try a similar approach
                originalDepartments.forEach(option => {
                    if (option.value) {
                        // Use parent indices or naming patterns to infer relationships
                        const directionOptions = Array.from(directionSelect.options);
                        for (const directionOption of directionOptions) {
                            if (directionOption.value && option.text.includes(directionOption.text)) {
                                option.setAttribute('data-direction-id', directionOption.value);
                                break;
                            }
                        }
                    }
                });
                
                // Similar approach for team options
                originalTeams.forEach(option => {
                    if (option.value) {
                        // Use parent indices or naming patterns to infer relationships
                        const departmentOptions = Array.from(departmentSelect.options);
                        for (const deptOption of departmentOptions) {
                            if (deptOption.value && option.text.includes(deptOption.text)) {
                                option.setAttribute('data-department-id', deptOption.value);
                                break;
                            }
                        }
                    }
                });
                
                // And for cell options
                originalCells.forEach(option => {
                    if (option.value) {
                        const teamOptions = Array.from(teamSelect.options);
                        for (const teamOption of teamOptions) {
                            if (teamOption.value && option.text.includes(teamOption.text)) {
                                option.setAttribute('data-team-id', teamOption.value);
                                break;
                            }
                        }
                    }
                });
                
                // Set up proper dropdown events
                setupDropdownEvents();
            } catch (error) {
                console.error('Error during manual hierarchy inference:', error);
                // Fall back to basic filter events
                setupBasicFilterEvents();
            }

            // Try API as a backup for better hierarchy data
            fetch('/api/organization/hierarchy')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Failed to fetch hierarchy data');
                    }
                    return response.json();
                })
                .then(data => {
                    // Add data-region-id to direction options
                    originalDirections.forEach(option => {
                        if (option.value) {
                            const direction = data.directions.find(d => d.direction_id.toString() === option.value);
                            if (direction) {
                                option.setAttribute('data-region-id', direction.region_id);
                            }
                        }
                    });
                    
                    // Add data-direction-id to department options
                    originalDepartments.forEach(option => {
                        if (option.value) {
                            const department = data.departments.find(d => d.department_id.toString() === option.value);
                            if (department) {
                                option.setAttribute('data-direction-id', department.direction_id);
                            }
                        }
                    });
                    
                    // Add data-department-id to team options
                    originalTeams.forEach(option => {
                        if (option.value) {
                            const team = data.teams.find(t => t.team_id.toString() === option.value);
                            if (team) {
                                option.setAttribute('data-department-id', team.department_id);
                            }
                        }
                    });
                    
                    // Add data-team-id to cell options
                    originalCells.forEach(option => {
                        if (option.value) {
                            const cell = data.cells.find(c => c.cell_id.toString() === option.value);
                            if (cell) {
                                option.setAttribute('data-team-id', cell.team_id);
                            }
                        }
                    });
                    
                    // Once data is loaded, set up the event listeners
                    setupDropdownEvents();
                })
                .catch(error => {
                    console.error('Error loading hierarchy data:', error);
                    // Already handled with manual inference, no need for additional fallback
                });
        }
        
        // Set up event listeners for dropdowns
        function setupDropdownEvents() {
            // Region changes affect Directions
            regionSelect.addEventListener('change', function(e) {
                // Stop propagation to prevent duplicate filter event
                e.stopPropagation();
                updateDropdowns(regionSelect, directionSelect, originalDirections, 'data-region-id');
            });
            
            // Direction changes affect Departments
            directionSelect.addEventListener('change', function(e) {
                // Stop propagation to prevent duplicate filter event
                e.stopPropagation();
                updateDropdowns(directionSelect, departmentSelect, originalDepartments, 'data-direction-id');
            });
            
            // Department changes affect Teams
            departmentSelect.addEventListener('change', function(e) {
                // Stop propagation to prevent duplicate filter event
                e.stopPropagation();
                updateDropdowns(departmentSelect, teamSelect, originalTeams, 'data-department-id');
            });
            
            // Team changes affect Cells
            teamSelect.addEventListener('change', function(e) {
                // Stop propagation to prevent duplicate filter event
                e.stopPropagation();
                updateDropdowns(teamSelect, cellSelect, originalCells, 'data-team-id');
            });
        }
        
        // Fallback method if we can't load hierarchy data
        function setupBasicFilterEvents() {
            const form = document.getElementById('attendance-filter-form');
            
            const setupDebounceHandler = (element) => {
                if (element) {
                    element.addEventListener('change', function(e) {
                        e.preventDefault();
                        form.dispatchEvent(new Event('submit'));
                    });
                }
            };
            
            setupDebounceHandler(regionSelect);
            setupDebounceHandler(directionSelect);
            setupDebounceHandler(departmentSelect);
            setupDebounceHandler(teamSelect);
            setupDebounceHandler(cellSelect);
            setupDebounceHandler(document.getElementById('name_search'));
            setupDebounceHandler(document.getElementById('is_active'));
        }
        
        // Initialize dropdown options with relationships
        initDropdownOptions();
        
        // Load any saved filters from localStorage
        loadSavedFilters();
    });
</script>
{% endblock %}
